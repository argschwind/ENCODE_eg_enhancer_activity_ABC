# ENCODE4 distal regulation enhancer activity ABC models

Workflow to compute ABC models using different ENCODE 1D chromatin assays to estimate enhancer
activity in K562 as analyzed in the ENCODE distal regulation companion paper.

## Enhancer activity features in E-G models
This workflow quantifies enhancer activity using different ENCODE chromatin assays, including DNA
accessibility, histone and TF ChIP-seq. Enhancer activities based on the different assays are
computed for candidate elements derived from DNase-seq (or possibly ATAC-seq) generated by ABC. The
workflow also uses the approach implemented in ABC to calculate enhancer activities for these
elements.

Following outputs are generated:

**Enhancer activity ABC scores**
ABC predictions using each of 523 ENCODE chromatin experiments to compute enhancer activity. This
file contains one ABC score column for each chromatin experiment. To manage file size, these
predictions are only assembled for elements overlapping the combined K562 CRISPR data. However, the
workflow could be used to generate genome-wide predictions (see below). ABC predictions are generated
for chromatin assays quantified from both .bam and .bigWig (used in paper) input files as well as
for models usingthe chromatin assay only (assayOnly, used in paper) and multiplied by
DNA accessibility (assayDHS). To benchmark enhancer activity ABC models against CRISPR data, the
workflow also produces config files required by the
[CRISPR benchmarking pipeline](https://github.com/EngreitzLab/CRISPR_comparison).

Output files containing ABC predictions for the CRISPR E-G pairs:
- results/bigWig/K562/assayOnly_abc_models_crispr.tsv.gz
- results/bigWig/K562/assayDHS_abc_models_crispr.tsv.gz
- results/bam/K562/assayOnly_abc_models_crispr.tsv.gz
- results/bam/K562/assayDHS_abc_models_crispr.tsv.gz

Config files for the CRISPR benchmarking pipeline:
- results/bigWig/K562/EnhActABC_distal_reg_pred_config_bigWig.tsv
- results/bam/K562/EnhActABC_distal_reg_pred_config_bam.tsv

**Enhancer activity features**
As a secondary output, the workflow also allows generating enhancer activity features for the 523
chromatin assays to use in the ENCODE-rE2G modeling framework, including the P300 feature in
ENCODE-rE2G_extended. By default these are only generated for quantifications from .bigWig files,
but files for .bam files can easily be generated using the file type wildcard
(e.g. `results/bam/K562/EnhAct_features_ABC_egPairs.tsv.gz`).

Output files containing enhancer activity E-G features:
- results/bigWig/K562/EnhAct_features_ABC_egPairs.tsv.gz
- results/bam/K562/EnhAct_features_ABC_egPairs.tsv.gz

## Required inputs
The workflow  handles downloading chromatin assay .bigWig and .bam files from the ENCODE
portal. ENCODE file accessions for each chromatin assay file to use are provided via the
`config/encode4_chromatin_data.yml` file, which could be edited to adapt the workflow to new data or
additional cell types.

In addition to chromatin data, the workflow also requires candidate elements and E-G pairs
as defined by the ABC model. These are taken from the
`macs2_peaks.narrowPeak.sorted.candidateRegions.bed` and `EnhancerPredictionsAllPutative.tsv.gz`
ABC output files for the used cell types. See the snakemake config file (`config/config.yml`) for
examples. These files can be generated by applying the ABC model or downloading ABC predictions
from the ENCODE portal.

Finally, the workflow requires the CRISPR E-G file used to benchmark enhancer activity ABC 
predictions (see above). By default, the workflow downloads and uses the combined K562 training
dataset, but alternative CRISPR files could be provided by editing the `crispr_data` entry in the
`config/config.yml` file.

## Executing the workflow
To run the snakemake workflow, make sure that both snakemake and conda are installed. Snakemake can
uses conda to create environments containing all other required dependencies. Due to the large
number of steps, the workflow should be ran on an HPC cluster that allows parallelization of
snakemake jobs (see snakemake documentation for instructions).

The workflow will download and generate a large number of temporary files. It's recommended to use a
dedicated directory for all download and temporary files, for example on the scratch space of the
used HPC. This can be configured by modifying the `scratch` entry in the `config/config.yml` file.

To generate all output files, simply run the full workflow by executing:

```sh
# execute full workflow to generate all output files
snakemake --use-conda --profile <cluster_profile> -j100 -n
```

To only generate specific output files, run for example:

```sh
# execute full workflow to generate all output files
snakemake --use-conda --profile <cluster_profile> results/bigWig/K562/assayOnly_abc_models_crispr.tsv.gz -j100 -n
```

## Generating genome-wide enhancer activity ABC predictions
By default the workflow only assembles ABC predictions for E-G pairs overlapping the provided
CRISPR data to maintain a small output file size to use in the CRISPR benchmarking pipeline. To
generate genome-wide predictions, run for example:

```sh
# execute full workflow to generate all output files
snakemake --use-conda --profile <cluster_profile> results/bigWig/K562/assayOnly_abc_models_full.tsv.gz -j100 -n
```

Note that this feature is experimental and needs a high amount of memory and will generate very large
output files.

## Generating enhancer activity models in other cell types
The workflow is set up to generate ABC predictions using chromatin assays in K562 and possibly
GM12878 (genome-wide only). It could be used to generate predictions in other cell types as well by
providing following cell type specific inputs:
- ABC predictions in `config/config.yml`
- ENCODE portal accessions for chromatin data in `config/encode4_chromatin_data.yml`
- Default DNA accessibility accessions specified by `default_dnase` in config/config.yml`

Note that this functionality hasn't been tested.
